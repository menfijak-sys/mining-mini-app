<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TON Mining Mini App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  color: white;
  background: url("1769093138394.jpg") center/cover no-repeat fixed;
}

.overlay {
  background: rgba(0,0,0,0.7);
  min-height: 100vh;
  padding: 20px;
}

.box {
  background: rgba(0,0,0,0.6);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  background: #22c55e;
  color: black;
}
</style>
</head>

<body>
<div class="overlay">

<h2>⛏️ Mining Dashboard</h2>

<div class="box">
  <p><b>User:</b> <span id="username">Loading...</span></p>
  <p><b>Balance:</b> <span id="balance">0</span> TON</p>
  <p><b>Next Claim In:</b> <span id="timer">Loading...</span></p>
  <p><b>Referrals:</b> <span id="referrals">0</span></p>
</div>

<div class="box">
  <p><b>Your Referral Link:</b></p>
  <p id="refLink">Generating...</p>
</div>

<button onclick="claim()">Claim Mining Reward</button>
<button onclick="withdraw()">Request Withdraw</button>

<script>
// Telegram
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe.user;
const startParam = tg.initDataUnsafe.start_param || null;

// SETTINGS
const CLAIM_INTERVAL = 5 * 60 * 1000; // 5 minutes
const CLAIM_AMOUNT = 0.1;
const REF_REWARD = 1;

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAlIwTDXbRaF1eSWjkIYX4MnmavkeVzDQw",
  authDomain: "miningminiapp.firebaseapp.com",
  projectId: "miningminiapp",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const userRef = db.collection("users").doc(user.id.toString());

// UI
document.getElementById("username").innerText =
  user.username ? "@" + user.username : user.first_name;

const referralCode = "t" + user.id;
document.getElementById("refLink").innerText =
  "https://t.me/TonMaiming_VIPbot?start=" + referralCode;

// CREATE / LOAD USER
userRef.get().then(doc => {
  if (!doc.exists) {

    const newUser = {
      userID: user.id,
      username: user.username || "",
      balance: 0,
      referrals: 0,
      referralCode: referralCode,
      referredBy: null,
      lastClaim: Date.now() - CLAIM_INTERVAL
    };

    userRef.set(newUser).then(() => {

      // HANDLE REFERRAL
      if (startParam && startParam !== referralCode) {
        db.collection("users")
          .where("referralCode", "==", startParam)
          .get()
          .then(snap => {
            if (!snap.empty) {
              snap.forEach(refDoc => {
                refDoc.ref.update({
                  referrals: firebase.firestore.FieldValue.increment(1),
                  balance: firebase.firestore.FieldValue.increment(REF_REWARD)
                });
                userRef.update({ referredBy: startParam });
              });
            }
          });
      }
    });

  } else {
    const d = doc.data();
    document.getElementById("balance").innerText = d.balance.toFixed(2);
    document.getElementById("referrals").innerText = d.referrals || 0;
  }
});

// CLAIM
function claim() {
  userRef.get().then(doc => {
    const d = doc.data();
    const now = Date.now();
    if (now - d.lastClaim < CLAIM_INTERVAL) {
      alert("Not ready yet!");
      return;
    }
    const newBalance = d.balance + CLAIM_AMOUNT;
    userRef.update({
      balance: newBalance,
      lastClaim: now
    });
    document.getElementById("balance").innerText = newBalance.toFixed(2);
  });
}

// TIMER
setInterval(() => {
  userRef.get().then(doc => {
    const d = doc.data();
    if (!d) return;

    const diff = CLAIM_INTERVAL - (Date.now() - d.lastClaim);
    if (diff <= 0) {
      document.getElementById("timer").innerText = "Ready!";
    } else {
      const m = Math.floor(diff / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      document.getElementById("timer").innerText =
        m + ":" + s.toString().padStart(2, "0");
    }
  });
}, 1000);

// WITHDRAW (manual)
function withdraw() {
  alert("Withdraw request sent (manual processing)");
}
</script>

</div>
</body>
</html>
